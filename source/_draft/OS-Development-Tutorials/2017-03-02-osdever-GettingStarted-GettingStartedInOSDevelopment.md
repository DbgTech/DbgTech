---
title: 《系统开发》之开始准备OS开发
date: 2017-03-02 10:00:32
tags:
- 操作系统
- 翻译
categories:
- 内核
- 翻译
---

原文地址：[http://www.osdever.net/tutorials/view/getting-started-in-os-development](http://www.osdever.net/tutorials/view/getting-started-in-os-development)

很多人都确实想要写一个操作系统，但是他们不知道从哪里开始，并且他们不知道他们需要了解什么样的编程语言。

好吧，其实我一开始写我的OS时，也是相同的想法，所以我写了这个教程，帮助刚刚开始OS开发的人。

我已经将这一部分写成了Q&A的形式，这更加容易理解。
<!-- more -->
**Q:** 编写我自己的操作系统，我需要了解什么样的语言呢？

**A:** 你最少应该了解一些汇编语言（ASM），你需要使用它去编写你的引导扇区（更多的内容见下一个问题），以及用于加速你的系统中一些工作。我建议你学习一下C/C++，因为它与ASM比起来更加容易理解的语言。那么你可以煎何使用C/C++和ASM来编写OS。你或许会考虑使用Pascal和ASM来替代C/C++和ASM来编写你的系统，但是我建议使用C/C++和ASM（注意使用C++和OS开发中会有一些特殊问题）。

**Q:** 什么是引导扇区？

**A:** 引导扇区是一个小型程序，它被保存在软盘或磁盘的最开始的地方。它的职责是找到你的内核（OS的主要部分，完成大多数任务），并把它加载到内存，运行它。

**Q:** 是不是我需要先有一个操作系统，然后再去开发我的OS？

**A:** 是的。很多人使用Windows或Linux用于OS开发。

**Q:** 我应该用那些编译器呢？

**A:** 对于汇编语言，我推荐NASM，它是免费的，并且有很好的文档支持，支持多种格式的文件输出，适用于多种OS平台，并且还是开源的，大部分的汇编例子都需要用它编译。对于C/C++，我建议使用Linux下的gcc，或是Windows平台下的DJGPP。

**Q:** 我如何让我的OS引导扇区可以引导？

**A:** 你需要将它输出为一个平坦模式二进制文件。对于NASM来说，使用-f bin参数来编译。如果你使用C/C++，需要使用链接器完成这个共组。（见下面一个问题）

**Q:** 链接器是什么，我如何用它来开发我的OS？

**A:** 链接器将编译器生成的输出文件链接成一个文件。对于OS开发，你通常是将一些文件链接成一个平坦模式的二进制文件。对于LD（多数时间用DJGPP和GCC的链接器）使用选项--oformat binary。如果你使用LD，你应该使用链接脚本，以更好地控制链接过程。参考[我的编写OS的建议](http://www.osdever.net/mysuggestions.php)。

**Q:** 什么是实模式？

**A:** 实模式是X86的一种状态，即刚刚开启机器时所处的状态。实模式有如下几个不足：

	1. 它缺乏保护，防止应用程序之间混乱和造成相互崩溃
	2. 运行时只有一个任务
	3. 你只有1M大小的地址空间
	4. 你必须段来访问内存

**Q:** 什么是保护模式？

**A:** 保护模式，也称作PMode，是从实模式进入的一种模式。保护模式与实模式相比，有如下几个优点：

	1. 保护模式具有保护的能力，可以保证应用程序不出现混乱，以及相互损毁。（这也是为什么这个模式叫做保护模式）
	2. 你可以同时有几个任务（像Windows 和 Linux一样）
	3. 有4G的地址空间，对的，确实是4Gb的地址空间（一旦A20-Gate开启，见下一个问题）
	4. 你可以看到分页访问内存

**Q:** 什么是A20门？

**A:** 8086微处理器（在286，386，486和奔腾处理器之前）只能够访问1MB的地址空间。对于这样的地址空间，20Bit的地址就足够了。然后，Intel发明了80286（常常叫做286）.80286可以访问16MB的地址空间，但是80286必须和8086兼容（即为8086编写的应用程序必须能够在80286上运行）。那如何解决这个问题呢？80286有更多的们用于地址范围，但是有一些应用程序要依赖于8086模式，即地址会在1MB地址处环回。由此就有了A20门，关闭后即可进行地址环回。

&emsp;&emsp;从8086的角度看：对于这样的地址1111111111111111111，在实模式下加上1之后，结果是0，因为你没有第21位地址（即A20），但是80286确实是有这个第21位地址线。

&emsp;&emsp;为了解决这个问题，Intel模式使得80286中A20-Gate不可用，以此来限制地址到20位。因此，要访问大于1M的内存，我们需要开启A20门。

**Q:** 什么是选择子？

**A:** 选择子（有时也被称为描述符）是一个段的定义。它包含了基本段属性的描述，例如段基址（它的开始地址），段界限（它的长度）。每一个选择子都是64位长。更多的描述可以参考GDT和LDT中的介绍。

**Q:** 什么是GDT？

**A:** GDT是一个包含了选择子对应项的表。它主要提供了寻找选择子对应内容的起始地址。

**Q:** 什么是中断？

**A:** 中断是一个信号，用于CPU当前正在运行的任务。它告诉CPU一个重要的事件到来了，例如硬件中断，CPU需要停下来当前的任务去执行对应的中断处理例程。中断处理器一个类特殊的函数，用于处理特定的中断（例如键盘上的一个按键）。由于中断有指定的属性，例如他们可以用于从ring3转向ring0层，这个可以用于在操作系统中作为一种进行系统调用的方法。Linux的系统调用就是通过中断来实现。

**Q:** 什么是PIC？

**A:** PIC，即Programmable Interrupt Controller,是一个用于收集硬件中断请求的设备，并且通知CPU有硬件中断发生了。当中断发生时，PIC和CPU通信，通知发生了什么请求，CPU会停下当前的任务，为这个请求执行中断处理例程。

**Q:** 什么是PIT？

**A:** PIT，即Programmable Interrupt Timer，一个可编程的硬件定时器（你可以修改它的速度），当它到期时会发起一个中断（IRQ 0）。它主要用于任务调度。

**Q:** 我应该按照什么顺序编写我的OS？

**A:** 好吧，你可以从任何地方开始，但是你肯定会以很多bugs而停止。我建议你从编写引导扇区开始，然后编写一个基础的内核，再向你的内核添加功能。

**Q:** 在引导期间，设置PMode的基本步骤是什么？

**A:** 	

	1. 关闭中断，这样不会导致混乱
	2. 创建GDT表
	3. 开启A20门
	4. 设置CR0的第一位为1
	5. 从GDT中加载正确的段寄存器
	6. 通过远跳转来为CS和EIP加载正确的值
	7. 现在就进入了保护模式

更多内容可以参考[Chris Giese编写的保护模式](http://www.osdever.net/tutorials/pm.php)

**Q:** 我的问题没有在此回答。我该怎么办？

**A:** 你可以给我写信，我会尽力回答你的问题，并且将它放到这里来（这个教程还远没有完成）。


By Andy @ 2017/03/02 10:00:17 